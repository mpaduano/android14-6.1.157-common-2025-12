name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CCACHE_DIR: /tmp/ccache
  CCACHE_MAXSIZE: 2G
  MAKE_JOBS: ${{ github.runner_arch == 'x64' && 'all' || '2' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential bc bison flex libssl-dev libelf-dev \
            libncurses5-dev git wget curl lz4 zstd python3 python3-pip \
            cpio kmod pahole pigz ninja-build patchelf xxd \
            rsync file

      - name: Cache Toolchains and CCACHE
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/toolchain
            /tmp/ccache
          key: ${{ runner.os }}-toolchains-ccache-${{ hashFiles('.github/workflows/*.yml') }}-v5
          restore-keys: |
            ${{ runner.os }}-toolchains-ccache-

      - name: Setup Custom Toolchain
        id: toolchain
        run: |
          set -e
          mkdir -p "${{ github.workspace }}/toolchain"
          cd "${{ github.workspace }}/toolchain"

          echo "üì• Downloading toolchains..."
          # Download GCC toolchains
          if [ ! -f "gcc-arm64.tar.xz" ]; then
            wget -q --show-progress -O gcc-arm64.tar.xz \
              "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz"
          fi

          if [ ! -f "gcc-arm32.tar.xz" ]; then
            wget -q --show-progress -O gcc-arm32.tar.xz \
              "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz"
          fi

          # For Clang, use a different approach since ZyCromerZ structure is different
          if [ ! -d "clang" ]; then
            echo "üì¶ Setting up Clang..."
            mkdir -p clang
            cd clang
            
            # Download the actual Clang release (pre-built binaries)
            wget -q --show-progress -O clang.tar.gz \
              "https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz"
            
            # Extract what we downloaded
            tar -xzf clang.tar.gz
            
            # The structure should now have bin/, lib/, etc.
            echo "Clang directory contents after extraction:"
            ls -la
            cd ..
          fi

          echo "üì¶ Extracting GCC toolchains..."
          # Extract GCC toolchains
          if [ ! -d "aarch64-gcc" ]; then
            tar -xf gcc-arm64.tar.xz
            ARM64_DIR=$(find . -maxdepth 1 -type d -name "*aarch64*" | head -1)
            if [ -n "$ARM64_DIR" ] && [ "$ARM64_DIR" != "aarch64-gcc" ]; then
              mv "$ARM64_DIR" aarch64-gcc
              echo "‚úì Renamed $ARM64_DIR to aarch64-gcc"
            fi
          fi

          if [ ! -d "arm-gcc" ]; then
            tar -xf gcc-arm32.tar.xz
            ARM32_DIR=$(find . -maxdepth 1 -type d -name "*arm-none*" | head -1)
            if [ -n "$ARM32_DIR" ] && [ "$ARM32_DIR" != "arm-gcc" ]; then
              mv "$ARM32_DIR" arm-gcc
              echo "‚úì Renamed $ARM32_DIR to arm-gcc"
            fi
          fi

          echo "üîç Final directory structure:"
          ls -la

          # Set paths - adjust based on actual Clang structure
          CLANG_BIN="$PWD/clang/bin"
          
          # If bin directory doesn't exist in clang, check if it's in a subdirectory
          if [ ! -d "$CLANG_BIN" ]; then
            echo "Looking for Clang bin directory..."
            CLANG_BIN=$(find clang -name "clang" -type f | head -1 | xargs dirname)
            if [ -z "$CLANG_BIN" ]; then
              CLANG_BIN=$(find clang -name "bin" -type d | head -1)
            fi
            if [ -z "$CLANG_BIN" ]; then
              echo "::error::Could not find Clang bin directory"
              find clang -type f -name "clang" -o -name "clang-*" | head -10
              exit 1
            fi
          fi

          ARM64_TOOLCHAIN="$PWD/aarch64-gcc/bin/aarch64-none-linux-gnu-"
          ARM32_TOOLCHAIN="$PWD/arm-gcc/bin/arm-none-eabi-"

          echo "CLANG_BIN=$CLANG_BIN" >> $GITHUB_ENV
          echo "ARM64_TOOLCHAIN=$ARM64_TOOLCHAIN" >> $GITHUB_ENV
          echo "ARM32_TOOLCHAIN=$ARM32_TOOLCHAIN" >> $GITHUB_ENV

          echo "‚úÖ Toolchains setup complete"
          echo "CLANG_BIN: $CLANG_BIN"
          echo "ARM64_TOOLCHAIN: $ARM64_TOOLCHAIN" 
          echo "ARM32_TOOLCHAIN: $ARM32_TOOLCHAIN"

      - name: Setup ccache
        run: |
          sudo apt-get install -y ccache
          echo "::add-path::/usr/lib/ccache"
          ccache --show-stats

      - name: Clone Kernel Source
        run: |
          if [ ! -d "kernel" ]; then
            git clone --depth=1 --branch=android14-6.1-2025-09 \
              https://android.googlesource.com/kernel/common kernel
          else
            cd kernel
            git fetch --depth=1 origin android14-6.1-2025-09
            git reset --hard origin/android14-6.1-2025-09
            cd ..
          fi

      - name: Integrate KernelSU
        run: |
          cd kernel
          for i in {1..3}; do
            if curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main; then
              echo "‚úÖ KernelSU integrated successfully"
              break
            fi
            echo "‚ö†Ô∏è KernelSU integration attempt $i failed, retrying..."
            sleep 10
          done

      - name: Clone and Integrate SuSFS
        run: |
          if [ ! -d "susfs" ]; then
            git clone --depth=1 --branch=gki-android14-6.1 \
              https://gitlab.com/simonpunk/susfs4ksu.git susfs
          fi
          cd kernel
          cp ../susfs/kernel_patches/fs/susfs.c fs/
          cp ../susfs/kernel_patches/include/linux/susfs.h include/linux/
          cp ../susfs/kernel_patches/include/linux/susfs_def.h include/linux/
          echo "‚úÖ SuSFS files integrated"

      - name: Apply All Patches
        id: patches
        run: |
          set +e
          cd kernel

          declare -A PATCH_MAP=(
            ["fix-clidr-uninitialized"]="."
            ["10_enable_susfs_for_ksu"]="KernelSU" 
            ["50_add_susfs_in_gki-android14-6.1"]="."
            ["fix_proc_base"]="."
          )

          PATCH_BASE="https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main"

          for patch_name in "${!PATCH_MAP[@]}"; do
            patch_dir="${PATCH_MAP[$patch_name]}"
            patch_url="$PATCH_BASE/${patch_name}.patch"
            
            echo "üîß Applying $patch_name to $patch_dir/"
            
            # Download patch
            if ! curl -fsSL "$patch_url" -o "/tmp/${patch_name}.patch"; then
              echo "‚ö†Ô∏è Failed to download $patch_name"
              continue
            fi

            # Apply patch
            if [ "$patch_dir" != "." ]; then
              if [ ! -d "$patch_dir" ]; then
                echo "‚ùå Directory $patch_dir not found, skipping $patch_name"
                continue
              fi
              cd "$patch_dir"
            fi

            if patch -p1 --forward --no-backup-if-mismatch < "/tmp/${patch_name}.patch" 2>&1; then
              echo "‚úÖ $patch_name applied successfully"
            else
              echo "‚ö†Ô∏è $patch_name failed to apply (may already be applied)"
            fi

            # Return to kernel root
            cd "${{ github.workspace }}/kernel"
            rm -f "/tmp/${patch_name}.patch"
          done

          set -e
          echo "üéâ All patches processed"

      - name: Configure Kernel
        id: config
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64

          # Setup environment
          export PATH="$CLANG_BIN:$PATH"
          export CROSS_COMPILE="$ARM64_TOOLCHAIN"
          export CROSS_COMPILE_COMPAT="$ARM32_TOOLCHAIN"

          echo "‚öôÔ∏è Generating kernel configuration..."
          
          # First generate base GKI config
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig

          # Use scripts/config to modify the config properly
          CONFIG_SCRIPT="./scripts/config"
          CONFIG_FILE="out/.config"

          # Enable all required configs
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_PA_BITS_48
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_4K_PAGES
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_TAGGED_ADDR_ABI
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_PAN
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_PTR_AUTH
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_SCHED_MC
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ENERGY_MODEL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CPU_FREQ_GOV_SCHEDUTIL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_UCLAMP_TASK
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_UCLAMP_TASK_GROUP
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CPU_FREQ
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CPUFREQ_DT
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CPU_IDLE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM_PSCI_CPUIDLE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_THERMAL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CPU_THERMAL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_FAIR_GROUP_SCHED
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_CORTEX_X3
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_CORTEX_A715
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_CORTEX_A510
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_COMPACTION
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_MQ_IOSCHED_DEADLINE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IOSCHED_BFQ
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_TRANSPARENT_HUGEPAGE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_TRANSPARENT_HUGEPAGE_MADVISE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_VA_BITS_48
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_SVE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_SME
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_ARM64_BTI
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_SCHED_CORE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_PERF_EVENTS
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_OPP
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_DEVFREQ_THERMAL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_THERMAL_GOV_POWER_ALLOCATOR
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_THERMAL_GOV_STEP_WISE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_THERMAL_GOV_FAIR_SHARE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_THERMAL_EMULATION
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_THERMAL_WRITABLE_TRIPS
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_POWER_CAP
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_NUMA_BALANCING
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CMA
          $CONFIG_SCRIPT --file $CONFIG_FILE --set-val CONFIG_CMA_AREAS 7
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_TCP_CONG_ADVANCED
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_TCP_CONG_CUBIC
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_NET_SCH_FQ
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_NET_SCH_FQ_CODEL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_NET_SCH_CAKE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_DEFAULT_FQ
          $CONFIG_SCRIPT --file $CONFIG_FILE --set-str CONFIG_DEFAULT_TCP_CONG "bbr"
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_F2FS_FS
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_F2FS_FS_XATTR
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_F2FS_FS_POSIX_ACL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_F2FS_FS_SECURITY
          $CONFIG_SCRIPT --file $CONFIG_FILE --disable CONFIG_LOCALVERSION_AUTO
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU
          $CONFIG_SCRIPT --file $CONFIG_FILE --disable CONFIG_KSU_KPROBES_HOOK
          $CONFIG_SCRIPT --file $CONFIG_FILE --disable CONFIG_KSU_DEBUG
          $CONFIG_SCRIPT --file $CONFIG_FILE --disable CONFIG_KSU_ALLOWLIST_WORKAROUND
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_LSM_SECURITY_HOOKS
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_SUS_PATH
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_SUS_MOUNT
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_SUS_KSTAT
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_TRY_UMOUNT
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_SPOOF_UNAME
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_ENABLE_LOG
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_OPEN_REDIRECT
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_KSU_SUSFS_SUS_MAP
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_TMPFS_XATTR
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_TMPFS_POSIX_ACL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_NF_TARGET_TTL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP6_NF_TARGET_HL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP6_NF_MATCH_HL
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_TCP_CONG_BBR
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_CCACHE
          $CONFIG_SCRIPT --file $CONFIG_FILE --disable CONFIG_TCP_CONG_BIC
          $CONFIG_SCRIPT --file $CONFIG_FILE --disable CONFIG_TCP_CONG_WESTWOOD
          $CONFIG_SCRIPT --file $CONFIG_FILE --disable CONFIG_TCP_CONG_HTCP
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET
          $CONFIG_SCRIPT --file $CONFIG_FILE --set-val CONFIG_IP_SET_MAX 256
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_BITMAP_IP
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_BITMAP_IPMAC
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_BITMAP_PORT
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_HASH_IP
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_HASH_IPPORT
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_HASH_IPPORTIP
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_HASH_IPPORTNET
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_HASH_NET
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_HASH_NETNET
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_HASH_NETPORT
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_IP_SET_HASH_NETIFACE
          $CONFIG_SCRIPT --file $CONFIG_FILE --enable CONFIG_LTO_CLANG_THIN
          $CONFIG_SCRIPT --file $CONFIG_FILE --disable CONFIG_LTO_CLANG_FULL
          $CONFIG_SCRIPT --file $CONFIG_FILE --set-str CONFIG_LOCALVERSION "-deepongi"

          # Remove ABI exports for WiFi fix
          rm -vf android/abi_gki_protected_exports_* || true

          # Final config generation to resolve dependencies
          echo "üîß Running olddefconfig to resolve dependencies..."
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

          echo "‚úÖ Kernel configuration complete"
          echo "üìã Final config summary:"
          grep -E "CONFIG_(KSU|SUSFS|LTO|ARM64)" out/.config | head -20

      - name: Build Kernel
        id: build
        continue-on-error: false
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64

          # Setup build environment
          export PATH="$CLANG_BIN:$PATH"
          export CROSS_COMPILE="$ARM64_TOOLCHAIN" 
          export CROSS_COMPILE_COMPAT="$ARM32_TOOLCHAIN"

          # Build flags for optimization
          export KBUILD_BUILD_TIMESTAMP=$(date -u -d "@$SOURCE_DATE_EPOCH")
          export KBUILD_BUILD_USER=github-actions
          export KBUILD_BUILD_HOST=github

          echo "üèóÔ∏è Starting kernel build with $(nproc) cores..."
          echo "üìä CCACHE stats before build:"
          ccache -s

          START_TIME=$SECONDS

          # Build with detailed output but only show errors in real-time
          make -j$(nproc) \
            LLVM_IAS=1 \
            LLVM=1 \
            ARCH=arm64 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT="$ARM32_TOOLCHAIN" \
            CROSS_COMPILE="$ARM64_TOOLCHAIN" \
            CC="ccache clang" \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out \
            2>&1 | tee build.log | grep -E "(error|warning|Error|Warning|FAILED)"

          BUILD_STATUS=${PIPESTATUS[0]}
          BUILD_TIME=$((SECONDS - START_TIME))

          echo "üìä CCACHE stats after build:"
          ccache -s

          if [ $BUILD_STATUS -eq 0 ] && [ -f out/arch/arm64/boot/Image.gz ]; then
            echo "‚úÖ Kernel built successfully in ${BUILD_TIME}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "‚ùå Kernel build failed after ${BUILD_TIME}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV  
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Upload Build Log on Failure
        if: failure() && steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs-${{ github.run_number }}
          path: |
            kernel/build.log
            kernel/out/.config
          retention-days: 30

      - name: Prepare AnyKernel3
        if: success()
        run: |
          git clone --depth=1 --branch=KernelSU \
            https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git .github

          # Copy kernel artifacts
          cp ../kernel/out/arch/arm64/boot/Image.gz ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./

          # Add build info
          echo "build.date=$(date -u +%Y-%m-%d)" > build.info
          echo "build.commit=${{ github.sha }}" >> build.info
          echo "build.run=${{ github.run_number }}" >> build.info

          echo "‚úÖ AnyKernel3 prepared"

      - name: Package Kernel
        if: success()
        run: |
          cd AnyKernel3
          KERNEL_VERSION="6.1.145"
          TIMESTAMP=$(date +%Y%m%d_%H%M)
          ZIP_NAME="GKI-KernelSU-SuSFS-${KERNEL_VERSION}-${TIMESTAMP}.zip"

          # Create flashable zip
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"

          # Generate checksums
          cd ..
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"

          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          
          echo "üì¶ Package created: $ZIP_NAME ($(du -h $ZIP_NAME | cut -f1))"
          echo "üìÑ SHA256: $(cat ${ZIP_NAME}.sha256)"
          echo "üìÑ MD5: $(cat ${ZIP_NAME}.md5)"

      - name: Upload Kernel Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
          retention-days: 30

      - name: Create Release
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Kernel Build #${{ github.run_number }}"
          body: |
            ## üöÄ GKI Kernel with KernelSU & SuSFS

            **Build #${{ github.run_number }}** ‚Ä¢ $(date -u +%Y-%m-%d)

            ### üìä Build Info
            - **Duration:** ${{ env.BUILD_TIME }} seconds
            - **Kernel:** 6.1.145
            - **Branch:** android14-6.1-2025-09
            - **Commit:** ${{ github.sha }}

            ### üîß Features
            - ‚úÖ KernelSU (main branch)
            - ‚úÖ SuSFS (gki-android14-6.1)
            - ‚úÖ Clang 22.0.0 + ThinLTO
            - ‚úÖ ARM64 optimizations
            - ‚úÖ BBR TCP congestion control
            - ‚úÖ Enhanced security hooks

            ### üì¶ Checksums
            **SHA256:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.sha256)
            ```
            **MD5:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.md5)
            ```

            ### ‚ö° Installation
            1. Download the ZIP file
            2. Verify checksums
            3. Flash in custom recovery
            4. Reboot and enjoy!

            > ‚ö†Ô∏è Always backup before flashing!
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
