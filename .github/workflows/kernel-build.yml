name: Build GKI Kernel with KernelSU Variants
on:
  workflow_dispatch:
    inputs:
      ksu_variant:
        description: 'KernelSU variant to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tiann
          - kowsu
          - mksu
      disable_susfs:
        description: 'Disable SuSFS features'
        required: false
        default: false
        type: boolean
      force_clean_build:
        description: 'Force clean build (ignore cache)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

env:
  CLANG_BIN: /mnt/Android/clang-22/bin
  ARM64_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
  ARM32_TOOLCHAIN: /mnt/Hawai/toolchains/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-
  CCACHE_DIR: /mnt/ccache/.ccache
  MAKE_JOBS: 8

jobs:
  setup:
    runs-on: [self-hosted, Linux, X64]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      enable_susfs: ${{ steps.config.outputs.enable_susfs }}
      force_clean: ${{ steps.config.outputs.force_clean }}
    steps:
      - name: Set Build Matrix
        id: set-matrix
        run: |
          VARIANT="${{ github.event.inputs.ksu_variant }}"
          
          if [ "$VARIANT" = "all" ]; then
            echo 'matrix={"variant":["tiann","kowsu","mksu"]}' >> $GITHUB_OUTPUT
          else
            echo "matrix={\"variant\":[\"$VARIANT\"]}" >> $GITHUB_OUTPUT
          fi
          echo "üéØ Building variant(s): $VARIANT"

      - name: Set Build Config
        id: config
        run: |
          ENABLE_SUSFS=true
          FORCE_CLEAN=false
          
          if [ "${{ github.event.inputs.disable_susfs }}" = "true" ]; then
            ENABLE_SUSFS=false
          fi
          if [ "${{ github.event.inputs.force_clean_build }}" = "true" ]; then
            FORCE_CLEAN=true
          fi
          
          echo "enable_susfs=$ENABLE_SUSFS" >> $GITHUB_OUTPUT
          echo "force_clean=$FORCE_CLEAN" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    env:
      ENABLE_SUSFS: ${{ needs.setup.outputs.enable_susfs }}
      FORCE_CLEAN: ${{ needs.setup.outputs.force_clean }}
      KSU_VARIANT: ${{ matrix.variant }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Store Workflow Commit Info
        run: |
          WORKFLOW_COMMIT=$(git rev-parse HEAD)
          WORKFLOW_COMMIT_SHORT=$(git rev-parse --short HEAD)
          WORKFLOW_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          WORKFLOW_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "WORKFLOW_COMMIT=$WORKFLOW_COMMIT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_SHORT=$WORKFLOW_COMMIT_SHORT" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_DATE=$WORKFLOW_COMMIT_DATE" >> $GITHUB_ENV
          echo "WORKFLOW_COMMIT_MSG=$WORKFLOW_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "üìù Workflow commit: $WORKFLOW_COMMIT_SHORT - $WORKFLOW_COMMIT_MSG"

      - name: Clone/Update Kernel Source
        run: |
          KERNEL_BRANCH="android14-6.1-2025-09"
          
          if [ -d "kernel/.git" ] && [ -f "kernel/Makefile" ]; then
            echo "üì¶ Kernel exists, resetting to upstream..."
            cd kernel
            git fetch origin $KERNEL_BRANCH --depth=1
            git reset --hard FETCH_HEAD
            git clean -fdx
            cd ..
          else
            echo "üì• Cloning kernel..."
            rm -rf kernel
            git clone --depth=1 --single-branch -b $KERNEL_BRANCH \
              https://github.com/aosp-mirror/kernel_common.git kernel
          fi
          
          # Verify
          if [ -f "kernel/Makefile" ]; then
            VERSION=$(grep "^VERSION" kernel/Makefile | cut -d' ' -f3)
            PATCHLEVEL=$(grep "^PATCHLEVEL" kernel/Makefile | cut -d' ' -f3)
            echo "‚úÖ Kernel version: $VERSION.$PATCHLEVEL"
          else
            echo "‚ùå Kernel not available"
            exit 1
          fi

      - name: Store Kernel Commit Info
        run: |
          cd kernel
          KERNEL_COMMIT=$(git rev-parse HEAD)
          KERNEL_COMMIT_SHORT=$(git rev-parse --short HEAD)
          KERNEL_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          KERNEL_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "KERNEL_COMMIT=$KERNEL_COMMIT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_SHORT=$KERNEL_COMMIT_SHORT" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_DATE=$KERNEL_COMMIT_DATE" >> $GITHUB_ENV
          echo "KERNEL_COMMIT_MSG=$KERNEL_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "üìù Kernel commit: $KERNEL_COMMIT_SHORT - $KERNEL_COMMIT_MSG"

      - name: Clone/Update SuSFS Source
        run: |
          SUSFS_BRANCH="gki-android14-6.1-dev"
          
          if [ -d "susfs4ksu/.git" ] && [ -d "susfs4ksu/kernel_patches" ]; then
            echo "üì¶ SuSFS exists, checking for updates..."
            cd susfs4ksu
            git fetch origin $SUSFS_BRANCH --depth=1
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse FETCH_HEAD)
            if [ "$LOCAL" = "$REMOTE" ]; then
              echo "‚úÖ SuSFS is up to date"
            else
              echo "üîÑ SuSFS has updates, syncing..."
              git reset --hard FETCH_HEAD
              git clean -fdx
            fi
            cd ..
          else
            echo "üì• Cloning SuSFS..."
            rm -rf susfs4ksu
            git clone --depth=1 --single-branch -b $SUSFS_BRANCH \
              https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu
          fi
          
          # Verify
          if [ -d "susfs4ksu/kernel_patches" ]; then
            echo "‚úÖ SuSFS verified"
          else
            echo "‚ùå SuSFS not available"
            exit 1
          fi

      - name: Store SuSFS Commit Info
        run: |
          cd susfs4ksu
          SUSFS_COMMIT=$(git rev-parse HEAD)
          SUSFS_COMMIT_SHORT=$(git rev-parse --short HEAD)
          SUSFS_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          SUSFS_COMMIT_MSG=$(git log -1 --format=%s)
          
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_SHORT=$SUSFS_COMMIT_SHORT" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_DATE=$SUSFS_COMMIT_DATE" >> $GITHUB_ENV
          echo "SUSFS_COMMIT_MSG=$SUSFS_COMMIT_MSG" >> $GITHUB_ENV
          
          echo "üìù SuSFS commit: $SUSFS_COMMIT_SHORT - $SUSFS_COMMIT_MSG"

      - name: Show CCACHE Status
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "üìÇ CCACHE directory: $CCACHE_DIR"
          echo "üìà CCACHE stats BEFORE build:"
          ccache -s | grep -E "(Cacheable calls|Hits|Misses|Hit rate|cache size)" || true

      - name: Clean ABI Exports
        run: |
          cd kernel
          echo "üßπ Cleaning ABI protected exports..."
          rm -vf android/abi_gki_protected_exports_* || true

      - name: Setup KernelSU - ${{ matrix.variant }}
        run: |
          cd kernel
          
          # Remove any existing KernelSU
          rm -rf KernelSU drivers/kernelsu
          
          case "${{ matrix.variant }}" in
            "tiann")
              echo "üì¶ Setting up tiann/KernelSU (Official)..."
              KSU_REPO="tiann/KernelSU"
              KSU_BRANCH="main"
              ;;
            "kowsu")
              echo "üì¶ Setting up KOWX712/KernelSU (KowSU)..."
              KSU_REPO="KOWX712/KernelSU"
              KSU_BRANCH="master"
              ;;
            "mksu")
              echo "üì¶ Setting up 5ec1cff/KernelSU (MKSU)..."
              KSU_REPO="5ec1cff/KernelSU"
              KSU_BRANCH="main"
              ;;
          esac
          
          # Clone KernelSU
          git clone --depth=1 --branch=$KSU_BRANCH \
            "https://github.com/$KSU_REPO" KernelSU
          
          # Get accurate version by unshallowing
          cd KernelSU
          echo "üìä Getting accurate commit count..."
          git fetch --unshallow 2>/dev/null || git fetch --depth=10000 2>/dev/null || true
          KSU_COUNT=$(git rev-list --count HEAD)
          KSU_VERSION=$((KSU_COUNT + 20000))
          
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          echo "KSU_REPO=$KSU_REPO" >> $GITHUB_ENV
          echo "KSU_BRANCH=$KSU_BRANCH" >> $GITHUB_ENV
          echo "‚úÖ KernelSU version: r$KSU_VERSION (commits: $KSU_COUNT) from $KSU_REPO"
          cd ..
          
          # Setup KernelSU in kernel tree
          ln -sf "$(pwd)/KernelSU/kernel" drivers/kernelsu
          
          # Verify symlink
          if [ -d "drivers/kernelsu" ] && [ -f "drivers/kernelsu/Kconfig" ]; then
            echo "‚úÖ KernelSU symlink created successfully"
          else
            echo "‚ùå KernelSU symlink failed, trying copy instead..."
            rm -rf drivers/kernelsu
            cp -r KernelSU/kernel drivers/kernelsu
            if [ -f "drivers/kernelsu/Kconfig" ]; then
              echo "‚úÖ KernelSU copied successfully"
            else
              echo "‚ùå KernelSU setup failed"
              exit 1
            fi
          fi
          
          # Add to Makefile if not present
          if ! grep -q "kernelsu" drivers/Makefile; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile
          fi
          
          # Add to Kconfig if not present
          if ! grep -q "kernelsu" drivers/Kconfig; then
            sed -i '/endmenu/i source "drivers/kernelsu/Kconfig"' drivers/Kconfig
          fi

      - name: Store KernelSU Commit Info
        run: |
          cd kernel/KernelSU
          KSU_COMMIT=$(git rev-parse HEAD)
          KSU_COMMIT_SHORT=$(git rev-parse --short HEAD)
          KSU_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          KSU_COMMIT_MSG=$(git log -1 --format=%s)
          KSU_COMMIT_AUTHOR=$(git log -1 --format='%an')
          
          echo "KSU_COMMIT=$KSU_COMMIT" >> $GITHUB_ENV
          echo "KSU_COMMIT_SHORT=$KSU_COMMIT_SHORT" >> $GITHUB_ENV
          echo "KSU_COMMIT_DATE=$KSU_COMMIT_DATE" >> $GITHUB_ENV
          echo "KSU_COMMIT_MSG=$KSU_COMMIT_MSG" >> $GITHUB_ENV
          echo "KSU_COMMIT_AUTHOR=$KSU_COMMIT_AUTHOR" >> $GITHUB_ENV
          
          echo "üìù KernelSU commit: $KSU_COMMIT_SHORT - $KSU_COMMIT_MSG"

      - name: Generate Comprehensive Changelog - ${{ matrix.variant }}
        run: |
          mkdir -p changelogs
          CHANGELOG_FILE="changelogs/CHANGELOG-${{ matrix.variant }}.md"
          
          echo "üìù Generating comprehensive changelog for ${{ matrix.variant }}..."
          
          # ============================================
          # HEADER SECTION
          # ============================================
          cat > "$CHANGELOG_FILE" << 'HEADER_EOF'
          # üìã Comprehensive Build Changelog
          
          HEADER_EOF
          
          # Add variant info
          case "${{ matrix.variant }}" in
            "tiann")
              echo "**Variant:** Official KernelSU (tiann)" >> "$CHANGELOG_FILE"
              ;;
            "kowsu")
              echo "**Variant:** KowSU Fork (KOWX712)" >> "$CHANGELOG_FILE"
              ;;
            "mksu")
              echo "**Variant:** MKSU Fork (5ec1cff)" >> "$CHANGELOG_FILE"
              ;;
          esac
          
          cat >> "$CHANGELOG_FILE" << HEADER_INFO
          **Build Number:** #${{ github.run_number }}
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **KernelSU Version:** r${{ env.KSU_VERSION }}
          **SuSFS:** ${{ env.ENABLE_SUSFS == 'true' && 'Enabled' || 'Disabled' }}
          
          ---
          
          HEADER_INFO
          
          # ============================================
          # COMPONENT VERSIONS TABLE
          # ============================================
          cat >> "$CHANGELOG_FILE" << 'TABLE_HEADER'
          ## üîñ Component Versions
          
          | Component | Current Commit | Date | Summary |
          |-----------|---------------|------|---------|
          TABLE_HEADER
          
          echo "| **KernelSU (${{ matrix.variant }})** | \`${{ env.KSU_COMMIT_SHORT }}\` | ${{ env.KSU_COMMIT_DATE }} | ${{ env.KSU_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **Kernel (android14-6.1-2025-09)** | \`${{ env.KERNEL_COMMIT_SHORT }}\` | ${{ env.KERNEL_COMMIT_DATE }} | ${{ env.KERNEL_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **SuSFS4KSU** | \`${{ env.SUSFS_COMMIT_SHORT }}\` | ${{ env.SUSFS_COMMIT_DATE }} | ${{ env.SUSFS_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          echo "| **Build Workflow** | \`${{ env.WORKFLOW_COMMIT_SHORT }}\` | ${{ env.WORKFLOW_COMMIT_DATE }} | ${{ env.WORKFLOW_COMMIT_MSG }} |" >> "$CHANGELOG_FILE"
          
          echo "" >> "$CHANGELOG_FILE"
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          
          # ============================================
          # CHECK FOR PREVIOUS BUILD
          # ============================================
          cd kernel/KernelSU
          PREVIOUS_TAG=$(git tag --list "${{ matrix.variant }}-build-*" --sort=-version:refname 2>/dev/null | head -n 1 || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # ============================================
            # INITIAL BUILD - Show recent commits
            # ============================================
            echo "## üéâ Initial Build" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "This is the first tracked build for the **${{ matrix.variant }}** variant. Below are the recent changes in each component:" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # KernelSU Recent Changes
            echo "### üîß KernelSU - ${{ matrix.variant }} (Last 10 commits)" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "**Repository:** https://github.com/${{ env.KSU_REPO }}" >> "../../$CHANGELOG_FILE"
            echo "**Branch:** ${{ env.KSU_BRANCH }}" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Kernel Recent Changes
            cd ../../kernel
            echo "### üêß Kernel - android14-6.1-2025-09 (Last 10 commits)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Repository:** https://github.com/aosp-mirror/kernel_common" >> "../$CHANGELOG_FILE"
            echo "**Branch:** android14-6.1-2025-09" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            # SuSFS Recent Changes
            cd ../susfs4ksu
            echo "### üõ°Ô∏è SuSFS4KSU (Last 10 commits)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Repository:** https://gitlab.com/simonpunk/susfs4ksu" >> "../$CHANGELOG_FILE"
            echo "**Branch:** gki-android14-6.1-dev" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            git log -10 --pretty=format:"- **%h** - %s (%an, %ar)" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            # Workflow Recent Changes
            cd ..
            echo "### ‚öôÔ∏è Build Workflow (Last 5 commits)" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "**Repository:** ${{ github.repository }}" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            git log -5 --pretty=format:"- **%h** - %s (%an, %ar)" -- .github/workflows/ >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            
            echo "---" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "_This is the initial tracked build. Future builds will show detailed changes since the last build._" >> "$CHANGELOG_FILE"
            
          else
            # ============================================
            # SUBSEQUENT BUILD - Show changes since last build
            # ============================================
            echo "## üîÑ Changes Since Last Build" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            echo "**Previous Build:** \`$PREVIOUS_TAG\`" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Get previous commit from last build metadata (we'll store this in a file)
            # For now, we'll check git tags to see if we have stored commit info
            PREV_KSU_COMMIT=$(git rev-parse "$PREVIOUS_TAG" 2>/dev/null || echo "")
            
            if [ -n "$PREV_KSU_COMMIT" ]; then
              COMMIT_RANGE="${PREV_KSU_COMMIT}..HEAD"
              KSU_CHANGE_COUNT=$(git rev-list --count $COMMIT_RANGE 2>/dev/null || echo "0")
            else
              # Fallback: try to get from notes or show last 5 commits
              KSU_CHANGE_COUNT="unknown"
              COMMIT_RANGE=""
            fi
            
            # KernelSU Changes
            echo "### üîß KernelSU - ${{ matrix.variant }}" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            if [ -n "$COMMIT_RANGE" ] && [ "$KSU_CHANGE_COUNT" != "0" ]; then
              echo "**Changes:** $KSU_CHANGE_COUNT commit(s)" >> "../../$CHANGELOG_FILE"
              echo "" >> "../../$CHANGELOG_FILE"
              git log $COMMIT_RANGE --pretty=format:"#### %h - %s%n%n**Author:** %an <%ae>  %n**Date:** %ad%n%n%b%n----%n" --date=format:'%Y-%m-%d %H:%M:%S' >> "../../$CHANGELOG_FILE"
            else
              echo "**Status:** No changes detected (or first build after tag migration)" >> "../../$CHANGELOG_FILE"
              echo "" >> "../../$CHANGELOG_FILE"
              echo "_Current commit:_ \`${{ env.KSU_COMMIT_SHORT }}\` - ${{ env.KSU_COMMIT_MSG }}" >> "../../$CHANGELOG_FILE"
            fi
            echo "" >> "../../$CHANGELOG_FILE"
            echo "" >> "../../$CHANGELOG_FILE"
            
            # Note: For kernel, SuSFS, and workflow - we'll show current state since we don't have previous tracking
            # This can be enhanced in future to store previous commits
            
            cd ../../kernel
            echo "### üêß Kernel - android14-6.1-2025-09" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.KERNEL_COMMIT_SHORT }}\` - ${{ env.KERNEL_COMMIT_MSG }}" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "_Note: Kernel tracking will be enhanced in future builds. Showing current commit._" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            cd ../susfs4ksu
            echo "### üõ°Ô∏è SuSFS4KSU" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.SUSFS_COMMIT_SHORT }}\` - ${{ env.SUSFS_COMMIT_MSG }}" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            echo "_Note: SuSFS tracking will be enhanced in future builds. Showing current commit._" >> "../$CHANGELOG_FILE"
            echo "" >> "../$CHANGELOG_FILE"
            
            cd ..
            echo "### ‚öôÔ∏è Build Workflow" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "**Current State:** \`${{ env.WORKFLOW_COMMIT_SHORT }}\` - ${{ env.WORKFLOW_COMMIT_MSG }}" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "_Note: Workflow tracking will be enhanced in future builds. Showing current commit._" >> "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
          fi
          
          # ============================================
          # FOOTER SECTION - Links and References
          # ============================================
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "## üîó Component Links" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### KernelSU (${{ matrix.variant }})" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/${{ env.KSU_REPO }}" >> "$CHANGELOG_FILE"
          echo "- **Branch:** ${{ env.KSU_BRANCH }}" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/${{ env.KSU_REPO }}/commit/${{ env.KSU_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "- **Full History:** https://github.com/${{ env.KSU_REPO }}/commits/${{ env.KSU_BRANCH }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### Kernel" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/aosp-mirror/kernel_common" >> "$CHANGELOG_FILE"
          echo "- **Branch:** android14-6.1-2025-09" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/aosp-mirror/kernel_common/commit/${{ env.KERNEL_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### SuSFS4KSU" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://gitlab.com/simonpunk/susfs4ksu" >> "$CHANGELOG_FILE"
          echo "- **Branch:** gki-android14-6.1-dev" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://gitlab.com/simonpunk/susfs4ksu/-/commit/${{ env.SUSFS_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### Build Workflow" >> "$CHANGELOG_FILE"
          echo "- **Repository:** https://github.com/${{ github.repository }}" >> "$CHANGELOG_FILE"
          echo "- **Commit:** https://github.com/${{ github.repository }}/commit/${{ env.WORKFLOW_COMMIT }}" >> "$CHANGELOG_FILE"
          echo "- **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$CHANGELOG_FILE"
          
          echo "" >> "$CHANGELOG_FILE"
          echo "---" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "_Generated automatically by GitHub Actions on $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> "$CHANGELOG_FILE"
          
          # Tag this build for future reference
          cd kernel/KernelSU
          git tag "${{ matrix.variant }}-build-${{ github.run_number }}" 2>/dev/null || true
          
          cd ../..
          
          # Display preview
          echo "üìù Changelog preview (first 50 lines):"
          head -n 50 "$CHANGELOG_FILE" || cat "$CHANGELOG_FILE"
          
          echo "CHANGELOG_FILE=$CHANGELOG_FILE" >> $GITHUB_ENV
          
          echo "‚úÖ Comprehensive changelog generated successfully!"

      - name: Setup SuSFS
        if: env.ENABLE_SUSFS == 'true'
        run: |
          echo "üì¶ Setting up SuSFS..."
          
          # Copy SuSFS files
          cp susfs4ksu/kernel_patches/fs/susfs.c kernel/fs/
          cp susfs4ksu/kernel_patches/include/linux/susfs.h kernel/include/linux/
          cp susfs4ksu/kernel_patches/include/linux/susfs_def.h kernel/include/linux/
          
          cd kernel
          
          # Apply kernel SuSFS patch - check for variant-specific first
          VARIANT_SUSFS_PATCH="../.github/patches/${{ matrix.variant }}/50_add_susfs_in_gki-android14-6.1.patch"
          DEFAULT_SUSFS_PATCH="../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"
          
          if [ -f "$VARIANT_SUSFS_PATCH" ]; then
            echo "üìã Applying variant-specific SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_SUSFS_PATCH" || true
          else
            echo "üìã Applying default SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_SUSFS_PATCH" || true
          fi
          
          # Apply KernelSU-specific SuSFS patch
          cd KernelSU
          VARIANT_KSU_PATCH="../../.github/patches/${{ matrix.variant }}/10_enable_susfs_for_ksu.patch"
          DEFAULT_KSU_PATCH="../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
          
          if [ -f "$VARIANT_KSU_PATCH" ]; then
            echo "üìã Applying variant-specific KSU SuSFS patch from .github/patches/${{ matrix.variant }}/"
            patch -p1 --forward < "$VARIANT_KSU_PATCH" || true
          else
            echo "üìã Applying default KSU SuSFS patch from susfs4ksu submodule"
            patch -p1 --forward < "$DEFAULT_KSU_PATCH" || true
          fi
          cd ..

      - name: Apply Remote Patches
        run: |
          cd kernel
          
          # CLIDR fix (essential for all variants)
          echo "üìã Applying fix-clidr-uninitialized.patch"
          curl -LSs "https://raw.githubusercontent.com/infectedmushi/kernel_patches/main/fix-clidr-uninitialized.patch" \
            -o /tmp/fix-clidr.patch
          patch -p1 --forward < /tmp/fix-clidr.patch || true

      - name: Patch Scripts
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion

      - name: Configure Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig
          
          # Base configuration
          cat >> out/.config << 'EOF'
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_DEBUG=n
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_NET_SCH_CAKE=y
          EOF
          
          # Variant-specific config
          case "${{ matrix.variant }}" in
            "tiann")
              echo 'CONFIG_LOCALVERSION="-deepongi+"' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
            "kowsu")
              echo 'CONFIG_LOCALVERSION="-deepongi+"' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
            "mksu")
              echo 'CONFIG_LOCALVERSION="-deepongi+"' >> out/.config
              echo 'CONFIG_KSU_KPROBES_HOOK=n' >> out/.config
              echo 'CONFIG_KSU_THRONE_TRACKER_ALWAYS_THREADED=y' >> out/.config
              echo 'CONFIG_KSU_ALLOWLIST_WORKAROUND=n' >> out/.config
              echo 'CONFIG_KSU_LSM_SECURITY_HOOKS=y' >> out/.config
              ;;
          esac
          
          # SuSFS configuration
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            cat >> out/.config << 'EOF'
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          EOF
          fi
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export PATH="${{ env.CLANG_BIN }}:/usr/lib/ccache:$PATH"
          export CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}"
          export CROSS_COMPILE_COMPAT="${{ env.ARM32_TOOLCHAIN }}"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CC="ccache clang"
          export CXX="ccache clang++"
          
          START_TIME=$SECONDS
          
          if [ "${{ env.FORCE_CLEAN }}" = "true" ]; then
            echo "üßπ Performing clean build..."
            make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out clean
          fi
          
          echo "üèóÔ∏è Building kernel for ${{ matrix.variant }}..."
          echo "üìÇ Using CCACHE at: $CCACHE_DIR"
          make -j$(nproc) LLVM_IAS=1 LLVM=1 O=out CC="ccache clang" 2>&1 | tee build.log
          
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_MINS=$((BUILD_TIME / 60))
          BUILD_SECS=$((BUILD_TIME % 60))
          echo "BUILD_TIME=${BUILD_MINS}m ${BUILD_SECS}s" >> $GITHUB_ENV

      - name: Check CCACHE Performance
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          echo "üìà CCACHE stats AFTER build:"
          ccache -s | grep -E "(Cacheable calls|Hits|Misses|Hit rate|cache size)" || true
          
          FINAL_CACHE_SIZE=$(ccache -s | grep "Cache size" | awk '{print $NF}' || echo "0")
          HIT_RATE=$(ccache -s | grep -i "hit rate" | head -1 | awk '{print $NF}' || echo "N/A")
          echo "FINAL_CACHE_SIZE=$FINAL_CACHE_SIZE" >> $GITHUB_ENV
          echo "CCACHE_HIT_RATE=$HIT_RATE" >> $GITHUB_ENV

      - name: Package Kernel
        run: |
          # Clone AnyKernel3
          git clone --depth=1 --branch=KernelSU \
            https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3
          cd AnyKernel3
          rm -rf .git .github
          
          # Copy kernel files
          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./
          
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          VARIANT_UPPER=$(echo "${{ matrix.variant }}" | tr '[:lower:]' '[:upper:]')
          
          if [ "${{ env.ENABLE_SUSFS }}" = "true" ]; then
            ZIP_NAME="AK3-6.1.145-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}-SUSFS.zip"
          else
            ZIP_NAME="AK3-6.1.145-${VARIANT_UPPER}-${TIMESTAMP}-r${{ env.KSU_VERSION }}.zip"
          fi
          
          zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
          cd ..
          
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.variant }}-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
            kernel/build.log
            ${{ env.CHANGELOG_FILE }}
          retention-days: 30

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ matrix.variant }}-build-${{ github.run_number }}
          name: "${{ matrix.variant }} Build #${{ github.run_number }}"
          body: |
            ## üöÄ GKI Kernel with ${{ matrix.variant == 'tiann' && 'KernelSU (Official)' || matrix.variant == 'kowsu' && 'KowSU Fork' || 'MKSU Fork' }}
            
            **Build #${{ github.run_number }}** ‚Ä¢ $(date -u +%Y-%m-%d)
            
            ### üìä Build Information
            | Property | Value |
            |----------|-------|
            | **Variant** | ${{ matrix.variant }} |
            | **KernelSU Version** | r${{ env.KSU_VERSION }} |
            | **SuSFS** | ${{ env.ENABLE_SUSFS == 'true' && '‚úÖ Enabled' || '‚ùå Disabled' }} |
            | **Build Time** | ${{ env.BUILD_TIME }} |
            | **CCACHE Hit Rate** | ${{ env.CCACHE_HIT_RATE }} |
            | **Cache Size** | ${{ env.FINAL_CACHE_SIZE }} |
            
            ### üîñ Component Versions
            | Component | Commit | Summary |
            |-----------|--------|---------|
            | **KernelSU** | `${{ env.KSU_COMMIT_SHORT }}` | ${{ env.KSU_COMMIT_MSG }} |
            | **Kernel** | `${{ env.KERNEL_COMMIT_SHORT }}` | ${{ env.KERNEL_COMMIT_MSG }} |
            | **SuSFS4KSU** | `${{ env.SUSFS_COMMIT_SHORT }}` | ${{ env.SUSFS_COMMIT_MSG }} |
            | **Workflow** | `${{ env.WORKFLOW_COMMIT_SHORT }}` | ${{ env.WORKFLOW_COMMIT_MSG }} |
            
            ### üìù Full Changelog
            
            üìã **[View Complete Changelog](https://github.com/${{ github.repository }}/releases/download/${{ matrix.variant }}-build-${{ github.run_number }}/CHANGELOG-${{ matrix.variant }}.md)**
            
            The comprehensive changelog includes detailed changes for:
            - KernelSU (${{ matrix.variant }} variant)
            - Linux Kernel (android14-6.1-2025-09)
            - SuSFS4KSU (filesystem hiding framework)
            - Build Workflow
            
            ### üì¶ Installation
            1. Flash `${{ env.KERNEL_ZIP }}` in custom recovery
            2. Reboot and enjoy!
            
            ### üîê Checksums
            See attached `.sha256` and `.md5` files for verification
            
            ### üîó Quick Links
            - **KernelSU Commit:** https://github.com/${{ env.KSU_REPO }}/commit/${{ env.KSU_COMMIT }}
            - **Kernel Commit:** https://github.com/aosp-mirror/kernel_common/commit/${{ env.KERNEL_COMMIT }}
            - **SuSFS Commit:** https://gitlab.com/simonpunk/susfs4ksu/-/commit/${{ env.SUSFS_COMMIT }}
            - **Build Workflow:** https://github.com/${{ github.repository }}/commit/${{ env.WORKFLOW_COMMIT }}
            - **Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
            ${{ env.CHANGELOG_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
